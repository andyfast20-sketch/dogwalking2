{% extends 'base.html' %}
{% block title %}Book a Walk{% endblock %}
{% block content %}
<section class="hero small" style="text-align:center">
  <h1 style="margin-bottom:12px">Book a Dog Walk</h1>
  <p style="margin:0">Choose an available time slot and we'll take great care of your pup!</p>
</section>

{% if success %}
<div class="container" style="max-width:700px;text-align:center;padding:60px 20px">
  <div style="background:linear-gradient(180deg,rgba(34,197,94,.12),rgba(34,197,94,.06));border:2px solid rgba(34,197,94,.3);border-radius:20px;padding:40px">
    <div style="font-size:4rem;margin-bottom:16px">‚úÖ</div>
    <h2 style="color:var(--brand);margin:0 0 12px">Booking Request Received!</h2>
    <p style="color:var(--text);font-size:1.1rem;margin:0 0 20px">Thank you for your booking. We'll review your request and confirm shortly via email.</p>
    <a href="{{ url_for('home') }}" class="btn primary" style="margin-top:12px">Return Home</a>
  </div>
</div>
{% else %}

<div class="container" style="max-width:1000px;padding:40px clamp(20px,5vw,60px)">
  
  {% if error %}
    <div style="background:rgba(239,68,68,.15);border:2px solid rgba(239,68,68,.3);border-radius:16px;padding:20px;margin-bottom:30px;text-align:center">
      <strong style="color:#fca5a5;font-size:1.1rem">‚ö†Ô∏è {{ error }}</strong>
    </div>
  {% endif %}
  
  <h2 style="margin:0 0 24px;color:var(--brand);text-align:center;font-size:1.8rem">üìÖ Available Time Slots</h2>
  
  {% if slots %}
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px">
      {% for slot in slots %}
        <button class="slot-box {% if slot.spaces_left == 0 %}full{% endif %}" 
                data-slot-id="{{ slot.id }}"
                data-slot-date="{{ slot.date }}"
                data-slot-time="{{ slot.time }}"
                data-slot-duration="{{ slot.duration_minutes }}"
                data-slot-price="{{ slot.price or '' }}"
                data-slot-notes="{{ slot.notes or '' }}"
                {% if slot.spaces_left == 0 %}disabled{% endif %}
                onclick="openBookingModal(this)">
          <div class="slot-box-date">{{ slot.date }}</div>
          <div class="slot-box-time">{{ slot.time }}</div>
          <div class="slot-box-duration">{{ slot.duration_minutes }} min</div>
          {% if slot.price %}
            <div class="slot-box-price">{{ slot.price }}</div>
          {% endif %}
          {% if slot.spaces_left > 0 %}
            <div class="slot-box-spaces">{{ slot.spaces_left }} spot{% if slot.spaces_left != 1 %}s{% endif %}</div>
          {% else %}
            <div class="slot-box-full">Fully Booked</div>
          {% endif %}
        </button>
      {% endfor %}
    </div>
  {% else %}
    <div style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:60px 40px;text-align:center">
      <div style="font-size:3rem;margin-bottom:12px">üì≠</div>
      <p style="color:var(--muted);margin:0;font-size:1.1rem">No booking slots available at the moment. Please check back soon or <a href="{{ url_for('contact') }}" style="color:var(--brand)">contact us</a> directly.</p>
    </div>
  {% endif %}
</div>

<!-- Booking Modal -->
<div id="booking-modal" class="modal" onclick="closeModalOnBackdrop(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closeBookingModal()">&times;</button>
    
    <h2 style="margin:0 0 8px;color:var(--brand);font-size:1.6rem">Book This Slot</h2>
    <div id="modal-slot-info" style="margin-bottom:24px;padding:12px;background:rgba(255,255,255,.04);border-radius:10px;text-align:center">
      <div style="font-weight:700;font-size:1.1rem;color:var(--text)" id="modal-slot-datetime"></div>
      <div style="color:var(--muted);font-size:.9rem;margin-top:4px" id="modal-slot-details"></div>
    </div>
    
    <form method="post" action="{{ url_for('book') }}" id="booking-form">
      <input type="hidden" name="slot_id" id="modal-slot-id" required>
      
      <div style="display:grid;gap:16px">
        <label style="display:flex;flex-direction:column;gap:6px">
          <strong style="color:var(--text);font-size:.9rem">Your Name *</strong>
          <input type="text" name="name" required 
            style="padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.95rem" />
        </label>
        
        <label style="display:flex;flex-direction:column;gap:6px">
          <strong style="color:var(--text);font-size:.9rem">Email Address *</strong>
          <input type="email" name="email" required 
            style="padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.95rem" />
        </label>
        
        <label style="display:flex;flex-direction:column;gap:6px">
          <strong style="color:var(--text);font-size:.9rem">Phone Number</strong>
          <input type="tel" name="phone" 
            style="padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.95rem" />
        </label>
        
        <label style="display:flex;flex-direction:column;gap:6px">
          <strong style="color:var(--text);font-size:.9rem">Dog's Name *</strong>
          <input type="text" name="dog_name" required 
            style="padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.95rem" />
        </label>
        
        <label style="display:flex;flex-direction:column;gap:6px">
          <strong style="color:var(--text);font-size:.9rem">Dog Info (breed, age, temperament)</strong>
          <textarea name="dog_info" rows="2" placeholder="e.g., Labrador, 3 years old, friendly"
            style="padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.95rem;font-family:inherit;resize:vertical"></textarea>
        </label>
        
        <label style="display:flex;flex-direction:column;gap:6px">
          <strong style="color:var(--text);font-size:.9rem">Service Type</strong>
          <select name="service_type" 
            style="padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.95rem">
            <option value="">Select a service...</option>
            <option value="Group Walk">Group Walk</option>
            <option value="Solo Walk">Solo Walk</option>
            <option value="Puppy Visit">Puppy Visit</option>
            <option value="Senior Care">Senior Care</option>
          </select>
        </label>
        
        <label style="display:flex;flex-direction:column;gap:6px">
          <strong style="color:var(--text);font-size:.9rem">Additional Message</strong>
          <textarea name="message" rows="2" placeholder="Any special requirements?"
            style="padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.95rem;font-family:inherit;resize:vertical"></textarea>
        </label>
        
        <div style="background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.05);border-radius:10px;padding:12px">
          <p style="margin:0;color:var(--muted);font-size:.75rem;line-height:1.5">
            <strong style="color:var(--text)">üìç Connection:</strong> <code style="background:rgba(255,255,255,.08);padding:1px 6px;border-radius:4px;font-family:monospace;font-size:.7rem;color:var(--brand)">{{ ip }}</code>
          </p>
        </div>
        
        <button type="submit" class="btn primary" style="padding:14px 28px;font-size:1.05rem;font-weight:700;margin-top:8px">
          Submit Booking Request
        </button>
      </div>
    </form>
  </div>
</div>

<style>
.slot-box {
  background: rgba(255,255,255,.04);
  border: 2px solid rgba(255,255,255,.1);
  border-radius: 12px;
  padding: 20px 16px;
  cursor: pointer;
  transition: all .3s;
  text-align: center;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.slot-box:not(.full):hover {
  background: rgba(34,197,94,.08);
  border-color: var(--brand);
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(34,197,94,.15);
}
.slot-box.full {
  opacity: .4;
  cursor: not-allowed;
  background: rgba(255,255,255,.02);
}
.slot-box-date {
  font-weight: 700;
  font-size: 1.1rem;
  color: var(--text);
}
.slot-box-time {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--brand);
}
.slot-box-duration {
  font-size: .85rem;
  color: var(--muted);
}
.slot-box-price {
  font-size: 1rem;
  font-weight: 600;
  color: var(--brand);
  margin-top: 4px;
}
.slot-box-spaces {
  background: rgba(34,197,94,.2);
  color: var(--brand);
  padding: 4px 10px;
  border-radius: 8px;
  font-size: .75rem;
  font-weight: 700;
  margin-top: 4px;
}
.slot-box-full {
  background: rgba(239,68,68,.2);
  color: #fca5a5;
  padding: 4px 10px;
  border-radius: 8px;
  font-size: .75rem;
  font-weight: 700;
  margin-top: 4px;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,.85);
  backdrop-filter: blur(8px);
  z-index: 10000;
  align-items: center;
  justify-content: center;
  animation: fadeIn .3s;
}
.modal.active {
  display: flex;
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
.modal-content {
  background: var(--bg);
  border: 2px solid rgba(255,255,255,.12);
  border-radius: 16px;
  padding: 32px;
  max-width: 500px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  animation: slideUp .3s cubic-bezier(.4,0,.2,1);
}
@keyframes slideUp {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.modal-close {
  position: absolute;
  top: 16px;
  right: 16px;
  background: rgba(239,68,68,.2);
  border: 1px solid rgba(239,68,68,.3);
  color: #fca5a5;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  font-size: 1.5rem;
  line-height: 1;
  cursor: pointer;
  transition: all .2s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.modal-close:hover {
  background: rgba(239,68,68,.3);
  transform: rotate(90deg);
}

@media (max-width: 650px) {
  .slot-box {
    padding: 16px 12px;
  }
  .slot-box-time {
    font-size: 1.1rem;
  }
  .modal-content {
    padding: 24px;
    width: 95%;
  }
}
</style>

<script>
function openBookingModal(button) {
  const modal = document.getElementById('booking-modal');
  const slotId = button.dataset.slotId;
  const date = button.dataset.slotDate;
  const time = button.dataset.slotTime;
  const duration = button.dataset.slotDuration;
  const price = button.dataset.slotPrice;
  const notes = button.dataset.slotNotes;
  
  document.getElementById('modal-slot-id').value = slotId;
  document.getElementById('modal-slot-datetime').textContent = `${date} at ${time}`;
  
  let details = `${duration} minutes`;
  if (price) details += ` ‚Ä¢ ${price}`;
  if (notes) details += ` ‚Ä¢ ${notes}`;
  document.getElementById('modal-slot-details').textContent = details;
  
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeBookingModal() {
  const modal = document.getElementById('booking-modal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
}

function closeModalOnBackdrop(event) {
  if (event.target.id === 'booking-modal') {
    closeBookingModal();
  }
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeBookingModal();
  }
});
</script>

{% endif %}
{% endblock %}
