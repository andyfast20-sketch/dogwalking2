<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Happy Paws Dog Walking{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  {% block extra_head %}{% endblock %}
</head>
<body>
  {% if maintenance_mode %}
  <!-- Maintenance Mode Banner -->
  <div style="background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;text-align:center;padding:16px 20px;font-weight:700;letter-spacing:.5px;font-size:1rem;box-shadow:0 4px 12px rgba(0,0,0,.3);position:relative;z-index:1000;border-bottom:3px solid #991b1b">
    <div style="max-width:1180px;margin:0 auto;display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap">
      <span style="font-size:1.5rem">‚ö†Ô∏è</span>
      <span>WEBSITE IS UNDER CONSTRUCTION - DO NOT PLACE ANY BOOKINGS</span>
      <span style="font-size:1.5rem">‚ö†Ô∏è</span>
    </div>
  </div>
  {% endif %}
  <header class="site-header">
    <div class="header-inner">
      <div class="logo-wrap">
        <div class="logo">üêæ Happy Paws</div>
        <img class="header-avatar" src="{{ url_for('static', filename='img/andy.jpg') }}" alt="Profile photo" width="44" height="44" loading="eager" decoding="async" fetchpriority="high" onerror="this.onerror=null;this.classList.add('fallback');this.src='https://image.pollinations.ai/prompt/portrait%20photo%20of%20friendly%20professional%20dog%20walker%20male%2C%20smiling%2C%20natural%20light%2C%20studio%20background%2C%20clean%2C%20modern?width=200&height=200&nologo=true'" />
      </div>
      <nav class="main-nav">
        <a href="{{ url_for('home') }}" class="{% if request.endpoint == 'home' %}active{% endif %}">Home</a>
        <a href="{{ url_for('about') }}" class="{% if request.endpoint == 'about' %}active{% endif %}">About</a>
        <a href="{{ url_for('services') }}" class="{% if request.endpoint == 'services' %}active{% endif %}">Services</a>
        <a href="{{ url_for('book') }}" class="cta-link {% if request.endpoint == 'book' %}active{% endif %}">Book a Walk</a>
        <a href="{{ url_for('gallery') }}" class="{% if request.endpoint == 'gallery' %}active{% endif %}">Gallery</a>
        <a href="{{ url_for('contact') }}" class="{% if request.endpoint == 'contact' %}active{% endif %}">Contact</a>
      </nav>
    </div>
  </header>
  <main>
    {% block content %}{% endblock %}
  </main>
  <footer class="site-footer">
    <p>&copy; {{ 2025 }} Happy Paws Dog Walking. All rights reserved.</p>
  </footer>
  
  <!-- Floating chat button -->
  {% set initial_mode = 'autopilot' if autopilot_enabled else 'live' %}
  <button
    id="chat-launch"
    class="floating-chat-btn {{ initial_mode }}"
    type="button"
    data-mode="{{ initial_mode }}"
    aria-label="{{ 'Chat with our AI assistant' if autopilot_enabled else 'Open live chat' }}"
    title="{{ 'AI Assistant Chat' if autopilot_enabled else 'Live Chat' }}"
  >
    {% if autopilot_enabled %}
      <img class="chat-icon" src="/static/img/dog-face.png" alt="Autopilot (dog)" />
    {% else %}
      üí¨
    {% endif %}
  </button>

  <script src="{{ url_for('static', filename='js/app.js') }}"></script>
  <script>
  (function(){
    const btn=document.getElementById('chat-launch');
    if(!btn) return;

    let autopilotMode=(btn.dataset.mode||'live')==='autopilot';
    let panel;
    let chatId=null;
    let lastId=0;
    let pollTimer;
    let introShown=false;

    function applyAutopilotMode(isAutopilot){
      autopilotMode=!!isAutopilot;
      btn.dataset.mode=autopilotMode?'autopilot':'live';
      btn.classList.toggle('autopilot',autopilotMode);
      btn.classList.toggle('live',!autopilotMode);
      btn.title=autopilotMode?'AI Assistant Chat':'Live Chat';
      btn.setAttribute('aria-label',autopilotMode?'Chat with our AI assistant':'Open live chat');
      if(autopilotMode){
        btn.innerHTML='<img src="/static/img/autopilot.png" alt="Autopilot" style="height:2em;width:2em;vertical-align:middle;" />';
      }else{
        btn.textContent='üí¨';
      }

      if(!panel) return;

      panel.classList.toggle('autopilot',autopilotMode);
      const headingEl=panel.querySelector('.chat-header strong');
      const inputEl=panel.querySelector('.chat-input');
      if(headingEl) headingEl.textContent=autopilotMode?'AI Assistant':'Live Chat';
      if(inputEl) inputEl.placeholder=autopilotMode?'Ask the AI about walks, pricing or availability...':'Type your message';
      if(!autopilotMode) introShown=false;
    }

    function buildPanel(){
      panel=document.createElement('div');
      panel.className='chat-panel';
      if(autopilotMode) panel.classList.add('autopilot');
      const heading=autopilotMode?'AI Assistant':'Live Chat';
      const placeholder=autopilotMode?'Ask the AI about walks, pricing or availability...':'Type your message';
      panel.innerHTML=`<div class="chat-header"><strong>${heading}</strong><button type="button" class="chat-close" aria-label="Close chat">√ó</button></div>
      <div class="chat-messages" aria-live="polite"></div>
      <form class="chat-form" autocomplete="off">
        <div class="chat-row"><input name="message" required placeholder="${placeholder}" class="chat-input" /><button class="chat-send" type="submit">Send</button></div>
      </form>`;
      document.body.appendChild(panel);
      panel.querySelector('.chat-close').addEventListener('click',closePanel);
      panel.querySelector('.chat-form').addEventListener('submit',onSend);
    }

    async function ensureChat(){
      if(chatId) return chatId;
      const data=new URLSearchParams();
      const r=await fetch('/chat/start',{method:'POST',body:data});
      const j=await r.json();
      if(j.ok) chatId=j.chat_id;
      return chatId;
    }

    function append(sender,text){
      if(!panel) return;
      const wrap=panel.querySelector('.chat-messages');
      const row=document.createElement('div');
      row.className='msg msg-'+sender;
      row.textContent=text;
      wrap.appendChild(row);
      wrap.scrollTop=wrap.scrollHeight;
    }

    async function poll(){
      if(!chatId) return;
      try{
        const r=await fetch(`/chat/poll/${chatId}?after=${lastId}`);
        if(!r.ok) return;
        const j=await r.json();
        if(j&&j.messages){
          for(const m of j.messages){
            append(m.sender,m.message);
            lastId=m.id;
          }
        }
      }catch(e){
        // no-op
      }
    }

    async function onSend(e){
      e.preventDefault();
      const form=e.target;
      const inp=form.querySelector('.chat-input');
      const msg=(inp.value||'').trim();
      if(!msg) return;
      await ensureChat();
      append('user',msg);
      inp.value='';
      const data=new URLSearchParams({chat_id:String(chatId),message:msg,sender:'user'});
      fetch('/chat/send',{method:'POST',body:data}).catch(()=>{});
    }

    async function openPanel(){
      if(!panel) buildPanel();
      panel.classList.add('open');
      await ensureChat();
      if(autopilotMode&&!introShown){
        append('system',"You're chatting with Andy's AI assistant.");
        introShown=true;
      }
      if(!pollTimer){
        pollTimer=setInterval(poll,1800);
        poll();
      }
    }

    function closePanel(){
      if(panel) panel.classList.remove('open');
    }

    btn.addEventListener('click',openPanel);
    applyAutopilotMode(autopilotMode);

    fetch('/chat/autopilot-status')
      .then(r=>r.ok?r.json():null)
      .then(data=>{
        if(!data||typeof data.autopilot==='undefined') return;
        if(data.autopilot!==autopilotMode) applyAutopilotMode(!!data.autopilot);
      })
      .catch(()=>{});
  })();
  </script>
  {% block extra_js %}{% endblock %}
</body>
</html>