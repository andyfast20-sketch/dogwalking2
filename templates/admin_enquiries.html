{% extends 'base.html' %}
{% block title %}Enquiries Admin{% endblock %}
{% block content %}
<section class="hero small">
  <h1>Enquiries</h1>
  {% if protected %}
    <p>Protected view (token validated).</p>
  {% else %}
    <p><strong>Warning:</strong> ADMIN_TOKEN not set; this page is currently public. Set an environment variable to secure it.</p>
  {% endif %}
  {% if deleted %}
    <div class="notice success" style="max-width:900px;margin:10px auto;">Enquiry deleted.</div>
  {% endif %}
</section>
<div class="container" style="overflow-x:auto;">
  {% if rows %}
    <table class="data-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Dog</th>
          <th>Status</th>
          <th>Created (UK)</th>
          <th>IP</th>
          <th>Visit Summary</th>
          <th>Message</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
          <tr>
            <td>{{ r.id }}</td>
            <td>
              <button type="button" class="link-btn" onclick="toggleMsg({{ r.id }})">{{ r.name }}</button>
              <div id="msg-{{ r.id }}" class="full-message" hidden>
                <div class="full-message-inner">
                  <h3>Message from {{ r.name }}</h3>
                  <p style="white-space:pre-wrap;">{{ r.message }}</p>
                  <div class="actions">
                    <button type="button" class="btn primary reply-btn" data-id="{{ r.id }}" data-email="{{ r.email }}" data-name="{{ r.name }}">Reply by email</button>
                    <button type="button" class="btn ghost copy-btn" data-id="{{ r.id }}">Copy message</button>
                    <button type="button" class="btn ghost" onclick="toggleMsg({{ r.id }})">Close</button>
                  </div>
                </div>
              </div>
            </td>
            <td><a class="email" href="mailto:{{ r.email }}">{{ r.email }}</a></td>
            <td>{{ r.dog or '—' }}</td>
            <td>
              <form method="post" action="{{ url_for('update_enquiry_status', enquiry_id=r.id, token=request.args.get('token')) }}" class="status-form">
                <select name="status" onchange="this.form.submit()">
                  {% set st = r.status %}
                  <option value="new" {{ 'selected' if st=='new' else '' }}>New</option>
                  <option value="in-progress" {{ 'selected' if st=='in-progress' else '' }}>In progress</option>
                  <option value="replied" {{ 'selected' if st=='replied' else '' }}>Replied</option>
                  <option value="closed" {{ 'selected' if st=='closed' else '' }}>Closed</option>
                </select>
              </form>
            </td>
            <td>{{ r.created_at|uk_datetime }}</td>
            <td>{{ r.ip or '—' }}</td>
            <td style="max-width:240px;white-space:pre-wrap;font-size:.8rem;">{% if r.visit_summary %}{{ r.visit_summary }}{% else %}
              <form method="post" action="{{ url_for('admin_enquiry_analyze', enquiry_id=r.id, token=request.args.get('token')) }}" style="display:inline;">
                <button class="btn ghost" type="submit" title="Generate AI summary">Analyze</button>
              </form>
            {% endif %}</td>
            <td style="max-width:320px;white-space:pre-wrap;">{{ r.message[:120] }}{% if r.message|length > 120 %}…{% endif %}</td>
            <td style="text-align:right;">
              <form method="post" action="{{ url_for('delete_enquiry', enquiry_id=r.id, token=request.args.get('token')) }}" onsubmit="return confirm('Delete this enquiry?');">
                <button class="btn danger" type="submit">Delete</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <p style="margin-top:16px;font-size:.9rem;">Download: <a href="{{ url_for('admin_enquiries_csv', token=request.args.get('token')) }}">CSV export</a> · <a href="{{ url_for('admin_visitors') }}">View all visitors</a></p>
  {% else %}
    <p>No enquiries yet.</p>
  {% endif %}
</div>
  <script>
  function toggleMsg(id){
    const box=document.getElementById('msg-'+id);
    if(!box)return;
    box.hidden=!box.hidden;
  }
  // Close modal when clicking the dimmed background
  document.addEventListener('click', (e)=>{
    const el = e.target;
    if(el.classList && el.classList.contains('full-message')){
      el.hidden = true;
    }
    if(el.matches && el.matches('.copy-btn')){
      const id = el.getAttribute('data-id');
      copyMsg(id);
    }
    if(el.matches && el.matches('.reply-btn')){
      const id = el.getAttribute('data-id');
      const email = el.getAttribute('data-email');
      const name = el.getAttribute('data-name');
      replyMsg(id, email, name);
    }
  });
  // Close on Escape
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      document.querySelectorAll('.full-message').forEach(m => { m.hidden = true; });
    }
  });

  function copyMsg(id){
    const p = document.querySelector('#msg-'+id+' .full-message-inner p');
    if(!p) return;
    const text = p.innerText || p.textContent || '';
    if(navigator.clipboard){
      navigator.clipboard.writeText(text).catch(()=>{});
    } else {
      // Fallback
      const ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta); ta.select();
      try{ document.execCommand('copy'); }catch(e){}
      document.body.removeChild(ta);
    }
  }

  function replyMsg(id, email, name){
    const p = document.querySelector('#msg-'+id+' .full-message-inner p');
    const body = p ? (p.innerText || p.textContent || '') : '';
    const subject = `Re: Your enquiry${name ? ', ' + name : ''}`;
    const href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = href;
  }
  </script>
{% endblock %}