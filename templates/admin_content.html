{% extends 'base.html' %}
{% block title %}Website Settings{% endblock %}
{% block content %}
<div style="max-width:1000px;margin:0 auto;padding:20px 20px 0">
  <a href="{{ url_for('admin_dashboard') }}" style="display:inline-flex;align-items:center;gap:8px;padding:10px 20px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:10px;color:var(--text);text-decoration:none;font-weight:600;transition:all .2s;margin-bottom:20px" onmouseover="this.style.background='rgba(255,255,255,.12)';this.style.transform='translateX(-4px)'" onmouseout="this.style.background='rgba(255,255,255,.08)';this.style.transform='translateX(0)'">
    ‚Üê Back to Dashboard
  </a>
</div>
<section class="container" style="max-width:1000px">
  <p style="margin-top:6px;color:var(--muted)">Edit the services & pricing section displayed on the home page.</p>
  
  <!-- Maintenance Mode Toggle -->
  <div id="maintenance" style="background:linear-gradient(180deg,rgba(245,158,11,.12),rgba(245,158,11,.06));border:2px solid rgba(245,158,11,.3);border-radius:16px;padding:24px;margin-top:24px;margin-bottom:32px">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px">
      <div>
        <h3 style="margin:0 0 8px;color:var(--accent-light);font-size:1.2rem">‚ö†Ô∏è Maintenance Mode</h3>
        <p style="margin:0;color:var(--text);font-size:.9rem">Display a warning banner at the top of all pages</p>
        <p style="margin:4px 0 0;color:var(--muted);font-size:.8rem">Message: "WEBSITE IS UNDER CONSTRUCTION - DO NOT PLACE ANY BOOKINGS"</p>
      </div>
      <form method="post" action="{{ url_for('admin_maintenance_toggle') }}" style="margin:0">
        <input type="hidden" name="enabled" value="{% if maintenance_mode_enabled %}false{% else %}true{% endif %}" />
        {% if maintenance_mode_enabled %}
        <button class="btn" type="submit" style="background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;padding:12px 24px;font-weight:700;white-space:nowrap">
          Turn OFF Maintenance Mode
        </button>
        {% else %}
        <button class="btn" type="submit" style="background:linear-gradient(135deg,var(--accent),var(--accent-light));color:#082621;padding:12px 24px;font-weight:700;white-space:nowrap">
          Turn ON Maintenance Mode
        </button>
        {% endif %}
      </form>
    </div>
    {% if maintenance_mode_enabled %}
    <div style="margin-top:16px;padding-top:16px;border-top:1px solid rgba(245,158,11,.2)">
      <div style="background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);border-radius:10px;padding:12px;text-align:center">
        <strong style="color:#fca5a5;font-size:.9rem">üö® WARNING BANNER IS CURRENTLY ACTIVE ON ALL PAGES</strong>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Chat Autopilot Toggle -->
  <div id="chat-autopilot" style="background:linear-gradient(180deg,rgba(34,197,94,.12),rgba(34,197,94,.06));border:2px solid rgba(34,197,94,.3);border-radius:16px;padding:24px;margin-bottom:32px">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px">
      <div>
        <h3 style="margin:0 0 8px;color:var(--brand);font-size:1.2rem">ü§ñ Chat Autopilot</h3>
        <p style="margin:0;color:var(--text);font-size:.9rem">Automatically answer live chat messages using AI when enabled.</p>
        <p style="margin:4px 0 0;color:var(--muted);font-size:.8rem">Uses OpenAI (preferred), DeepSeek, or Gemini API keys.</p>
        {% if not (has_openai or has_deepseek or has_gemini) %}
        <div style="margin-top:10px;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);border-radius:10px;padding:10px">
          <strong style="color:#fca5a5;font-size:.9rem">No AI provider keys detected. Set OPENAI_API_KEY, DEEPSEEK_API_KEY, or GEMINI_API_KEY in environment.</strong>
        </div>
        {% endif %}
      </div>
      <form method="post" action="{{ url_for('admin_chat_autopilot_toggle') }}" style="margin:0">
        <input type="hidden" name="enabled" value="{% if autopilot_enabled %}false{% else %}true{% endif %}" />
        {% if autopilot_enabled %}
        <button class="btn" type="submit" style="background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;padding:12px 24px;font-weight:700;white-space:nowrap">
          Turn OFF Autopilot
        </button>
        {% else %}
        <button class="btn" type="submit" style="background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;padding:12px 24px;font-weight:700;white-space:nowrap">
          Turn ON Autopilot
        </button>
        {% endif %}
      </form>
    </div>
  </div>

  <!-- Admin Notification Sound -->
  <div id="notifications-sound" style="background:linear-gradient(180deg,rgba(99,102,241,.04),rgba(99,102,241,.01));border:2px solid rgba(99,102,241,.06);border-radius:16px;padding:18px;margin-bottom:24px">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <h3 style="margin:0 0 6px;color:#6366f1;font-size:1.05rem">üîî Notification Sound</h3>
        <p style="margin:0;color:var(--muted);font-size:.9rem">Play a short ring and show a banner on admin pages when a new live visitor message arrives. Note: browsers may require a user gesture to allow audio playback.</p>
      </div>
      <form method="post" action="{{ url_for('admin_notifications_sound_toggle') }}" style="margin:0">
        <input type="hidden" name="enabled" value="{% if admin_notifications_sound %}false{% else %}true{% endif %}" />
        {% if admin_notifications_sound %}
        <button class="btn" type="submit" style="background:linear-gradient(135deg,#06b6d4,#0891b2);color:#fff;padding:10px 20px;font-weight:700">Disable Sound</button>
        {% else %}
        <button class="btn" type="submit" style="background:linear-gradient(135deg,#34d399,#10b981);color:#082621;padding:10px 20px;font-weight:700">Enable Sound</button>
        {% endif %}
      </form>
    </div>
  </div>

  <!-- Business Description for Autopilot Context -->
  <!-- API Keys for AI Providers (Admin only) -->
  <div id="api-keys" style="background:linear-gradient(180deg,rgba(99,102,241,.06),rgba(99,102,241,.02));border:2px solid rgba(99,102,241,.18);border-radius:16px;padding:24px;margin-bottom:32px">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap">
      <div style="flex:1;min-width:280px">
        <h3 style="margin:0 0 8px;color:#6366f1;font-size:1.1rem">üîë AI Provider API Keys (admin)</h3>
        <p style="margin:0;color:var(--muted);font-size:.9rem">Paste API keys for testing autopilot. Keys are stored encrypted in the database for admin use only and will be used immediately after saving.</p>
        <p style="margin:6px 0 0;color:var(--muted);font-size:.8rem">If you prefer not to store keys here, set environment variables instead (OPENAI_API_KEY, DEEPSEEK_API_KEY, GEMINI_API_KEY).</p>
      </div>
      <form method="post" action="{{ url_for('admin_api_keys_update') }}" style="flex:1;margin:0">
        <div style="display:grid;gap:10px">
          <label style="display:flex;flex-direction:column;gap:6px">
            <strong style="font-size:.85rem">Autopilot Provider</strong>
            <select name="AUTOPILOT_PROVIDER" style="padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);color:var(--text);font-size:.9rem">
              <option value="auto" {% if autopilot_provider == '' or autopilot_provider == 'auto' %}selected{% endif %}>Auto (choose best available)</option>
              <option value="openai" {% if autopilot_provider == 'openai' %}selected{% endif %}>OpenAI</option>
              <option value="deepseek" {% if autopilot_provider == 'deepseek' %}selected{% endif %}>DeepSeek</option>
              <option value="gemini" {% if autopilot_provider == 'gemini' %}selected{% endif %}>Gemini</option>
            </select>
            <small style="color:var(--muted);font-size:.8rem">Choose which provider autopilot should prefer when replying to chats.</small>
          </label>
          <label style="display:flex;flex-direction:column;gap:6px">
            <strong style="font-size:.85rem">OpenAI API Key</strong>
            <input type="password" name="OPENAI_API_KEY" value="{{ ai_keys['OPENAI_API_KEY'] }}" placeholder="sk-..." autocomplete="new-password"
              style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);color:var(--text);font-size:.9rem" />
          </label>
          <label style="display:flex;flex-direction:column;gap:6px">
            <strong style="font-size:.85rem">DeepSeek API Key</strong>
            <input type="password" name="DEEPSEEK_API_KEY" value="{{ ai_keys['DEEPSEEK_API_KEY'] }}" placeholder="ds-..."
              style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);color:var(--text);font-size:.9rem" />
          </label>
          <label style="display:flex;flex-direction:column;gap:6px">
            <strong style="font-size:.85rem">DeepSeek Model (optional)</strong>
            <input type="text" name="DEEPSEEK_MODEL" value="{{ ai_keys['DEEPSEEK_MODEL'] }}" placeholder="e.g. gpt-4o" autocomplete="off"
              style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);color:var(--text);font-size:.9rem" />
            <small style="color:var(--muted);font-size:.8rem">If set, Quick AI Test will try this model first when contacting DeepSeek.</small>
          </label>
          <label style="display:flex;flex-direction:column;gap:6px">
            <strong style="font-size:.85rem">Gemini API Key</strong>
            <input type="password" name="GEMINI_API_KEY" value="{{ ai_keys['GEMINI_API_KEY'] }}" placeholder="ya29..."
              style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);color:var(--text);font-size:.9rem" />
          </label>
        </div>
        <div style="text-align:right;margin-top:10px">
          <button class="btn primary" type="submit" style="padding:10px 20px;font-weight:700">Save API Keys</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Quick AI Test Panel -->
  <div id="ai-test" style="background:linear-gradient(180deg,rgba(16,185,129,.04),rgba(16,185,129,.01));border:2px solid rgba(16,185,129,.12);border-radius:16px;padding:20px;margin-bottom:32px">
    <h3 style="margin:0 0 8px;color:var(--brand);font-size:1.05rem">üß™ Quick AI Test</h3>
    <p style="margin:0 0 12px;color:var(--muted);font-size:.9rem">Send a short prompt to a chosen provider to verify keys are working. Results are shown below for convenience.</p>
    <form method="post" action="{{ url_for('admin_api_test') }}">
      <div style="display:grid;grid-template-columns:200px 1fr;gap:12px;align-items:start">
        <label style="display:flex;flex-direction:column;gap:6px">
          <strong style="font-size:.85rem">Provider</strong>
          <select name="provider" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);color:var(--text)">
            <option value="openai">OpenAI</option>
            <option value="deepseek">DeepSeek</option>
            <option value="gemini">Gemini</option>
          </select>
        </label>
        <label style="display:flex;flex-direction:column;gap:6px">
          <strong style="font-size:.85rem">Prompt</strong>
          <textarea name="prompt" rows="2" placeholder="E.g. 'Say hello as a friendly dog walker.'" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);color:var(--text)"></textarea>
        </label>
      </div>
      <div style="text-align:right;margin-top:10px">
        <button class="btn primary" type="submit" style="padding:8px 16px;font-weight:700">Run Test</button>
      </div>
    </form>

    {% if ai_test_result %}
    <div style="margin-top:12px;padding:12px;border-radius:10px;background:rgba(0,0,0,.12);border:1px solid rgba(0,0,0,.06);">
      <strong style="display:block;margin-bottom:6px;color:var(--text)">Last test result</strong>
      <pre style="white-space:pre-wrap;margin:0;color:var(--muted);font-size:.95rem">{{ ai_test_result }}</pre>
    </div>
    {% endif %}
  </div>
  <div style="background:linear-gradient(180deg,rgba(139,92,246,.06),rgba(139,92,246,.02));border:2px solid rgba(139,92,246,.18);border-radius:16px;padding:24px;margin-bottom:32px">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap">
      <div style="flex:1;min-width:280px">
        <h3 style="margin:0 0 8px;color:#a78bfa;font-size:1.1rem">üìù Business Description (used by Autopilot)</h3>
        <p style="margin:0;color:var(--muted);font-size:.9rem">A short description of your business that the autopilot will include in its context when answering visitor questions. Keep it concise and informative (max ~800 characters).</p>
      </div>
  <form method="post" action="{{ url_for('admin_business_description_update') }}" style="flex:1;margin:0" id="business-description-form">
        <textarea name="business_description" rows="5" maxlength="2000" style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);color:var(--text);resize:vertical">{{ business_description }}</textarea>
        <div style="text-align:right;margin-top:10px">
          <button class="btn primary" type="submit" style="padding:10px 20px;font-weight:700">Save Business Description</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Hero Images Editor -->
  <div id="hero-images" style="background:linear-gradient(180deg,rgba(34,197,94,.08),rgba(34,197,94,.03));border:2px solid rgba(34,197,94,.25);border-radius:16px;padding:24px;margin-bottom:32px">
    <h3 style="margin:0 0 16px;color:var(--brand);font-size:1.2rem">üñºÔ∏è Hero Images</h3>
    <p style="margin:0 0 20px;color:var(--muted);font-size:.9rem">Change the images displayed in the hero slideshow and photo strip at the top of the homepage.</p>
    
    <form method="post" action="{{ url_for('admin_hero_images_update') }}">
      <div style="display:grid;gap:20px">
        <!-- Slideshow Images -->
        <div style="background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.05);border-radius:12px;padding:16px">
          <h4 style="margin:0 0 12px;color:var(--text);font-size:1rem">Main Slideshow (2 images)</h4>
          <div style="display:grid;gap:12px">
            <label style="display:flex;flex-direction:column;gap:6px">
              <strong style="font-size:.85rem">Image 1 URL</strong>
              <input type="url" name="hero_slide_1" value="{{ hero_imgs.hero_slide_1 }}" placeholder="https://example.com/image1.jpg"
                style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.9rem" />
            </label>
            <label style="display:flex;flex-direction:column;gap:6px">
              <strong style="font-size:.85rem">Image 2 URL</strong>
              <input type="url" name="hero_slide_2" value="{{ hero_imgs.hero_slide_2 }}" placeholder="https://example.com/image2.jpg"
                style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.9rem" />
            </label>
          </div>
        </div>
        
        <!-- Photo Strip Images -->
        <div style="background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.05);border-radius:12px;padding:16px">
          <h4 style="margin:0 0 12px;color:var(--text);font-size:1rem">Photo Strip (4 images)</h4>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px">
            <label style="display:flex;flex-direction:column;gap:6px">
              <strong style="font-size:.85rem">Photo 1 URL</strong>
              <input type="url" name="hero_strip_1" value="{{ hero_imgs.hero_strip_1 }}" placeholder="https://example.com/photo1.jpg"
                style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.9rem" />
            </label>
            <label style="display:flex;flex-direction:column;gap:6px">
              <strong style="font-size:.85rem">Photo 2 URL</strong>
              <input type="url" name="hero_strip_2" value="{{ hero_imgs.hero_strip_2 }}" placeholder="https://example.com/photo2.jpg"
                style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.9rem" />
            </label>
            <label style="display:flex;flex-direction:column;gap:6px">
              <strong style="font-size:.85rem">Photo 3 URL</strong>
              <input type="url" name="hero_strip_3" value="{{ hero_imgs.hero_strip_3 }}" placeholder="https://example.com/photo3.jpg"
                style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.9rem" />
            </label>
            <label style="display:flex;flex-direction:column;gap:6px">
              <strong style="font-size:.85rem">Photo 4 URL</strong>
              <input type="url" name="hero_strip_4" value="{{ hero_imgs.hero_strip_4 }}" placeholder="https://example.com/photo4.jpg"
                style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.9rem" />
            </label>
          </div>
        </div>
      </div>
      
      <div style="margin-top:16px;text-align:right">
        <button class="btn primary" type="submit" style="padding:12px 24px;font-weight:700">Save Hero Images</button>
      </div>
    </form>
  </div>
  
  <!-- Meet Andy Section Editor -->
  <div id="meet-andy" style="background:linear-gradient(180deg,rgba(59,130,246,.08),rgba(59,130,246,.03));border:2px solid rgba(59,130,246,.25);border-radius:16px;padding:24px;margin-bottom:32px">
    <h3 style="margin:0 0 16px;color:#60a5fa;font-size:1.2rem">üë§ Meet Andy Section</h3>
    <p style="margin:0 0 20px;color:var(--muted);font-size:.9rem">Edit the heading, description paragraphs, and feature badges displayed in the About section.</p>
    
    <form method="post" action="{{ url_for('admin_meet_andy_update') }}">
      <div style="display:grid;gap:16px">
        <!-- Heading -->
        <label style="display:flex;flex-direction:column;gap:6px">
          <strong style="font-size:.9rem">Section Heading</strong>
          <input type="text" name="heading" value="{{ meet_andy.heading.content }}" required
            style="padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:1rem" />
          <small style="color:var(--muted);font-size:.8rem">Main title for the About section (e.g., "Meet Andy")</small>
        </label>
        
        <!-- Paragraph 1 -->
        <label style="display:flex;flex-direction:column;gap:6px">
          <strong style="font-size:.9rem">First Paragraph</strong>
          <textarea name="paragraph1" rows="3" required
            style="padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:1rem;font-family:inherit;line-height:1.6;resize:vertical">{{ meet_andy.paragraph1.content }}</textarea>
          <small style="color:var(--muted);font-size:.8rem">Introduction paragraph</small>
        </label>
        
        <!-- Paragraph 2 -->
        <label style="display:flex;flex-direction:column;gap:6px">
          <strong style="font-size:.9rem">Second Paragraph</strong>
          <textarea name="paragraph2" rows="3" required
            style="padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:1rem;font-family:inherit;line-height:1.6;resize:vertical">{{ meet_andy.paragraph2.content }}</textarea>
          <small style="color:var(--muted);font-size:.8rem">Second paragraph with additional details</small>
        </label>
        
        <!-- Feature Badges -->
        <div style="background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.05);border-radius:12px;padding:16px">
          <h4 style="margin:0 0 12px;color:var(--text);font-size:1rem">Feature Badges (4 items)</h4>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px">
            <label style="display:flex;flex-direction:column;gap:6px">
              <strong style="font-size:.85rem">Badge 1</strong>
              <input type="text" name="badge1" value="{{ meet_andy.badge1.content }}" required
                style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.9rem" />
            </label>
            <label style="display:flex;flex-direction:column;gap:6px">
              <strong style="font-size:.85rem">Badge 2</strong>
              <input type="text" name="badge2" value="{{ meet_andy.badge2.content }}" required
                style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.9rem" />
            </label>
            <label style="display:flex;flex-direction:column;gap:6px">
              <strong style="font-size:.85rem">Badge 3</strong>
              <input type="text" name="badge3" value="{{ meet_andy.badge3.content }}" required
                style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.9rem" />
            </label>
            <label style="display:flex;flex-direction:column;gap:6px">
              <strong style="font-size:.85rem">Badge 4</strong>
              <input type="text" name="badge4" value="{{ meet_andy.badge4.content }}" required
                style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.9rem" />
            </label>
          </div>
          <small style="color:var(--muted);font-size:.8rem;display:block;margin-top:8px">Include checkmarks (‚úì) or emojis at the start of each badge text</small>
        </div>
      </div>
      
      <div style="margin-top:16px;text-align:right">
        <button class="btn primary" type="submit" style="padding:12px 24px;font-weight:700">Save Meet Andy Section</button>
      </div>
    </form>
  </div>
  
  <!-- Contact Info Section Editor -->
  <div id="contact" style="background:linear-gradient(180deg,rgba(245,158,11,.08),rgba(245,158,11,.03));border:2px solid rgba(245,158,11,.25);border-radius:16px;padding:24px;margin-bottom:32px">
    <h3 style="margin:0 0 16px;color:var(--accent-light);font-size:1.2rem">üìû Contact Information</h3>
    <p style="margin:0 0 20px;color:var(--muted);font-size:.9rem">Edit the contact details displayed in the profile card on the homepage.</p>
    
    <form method="post" action="{{ url_for('admin_contact_update') }}">
      <div style="display:grid;gap:16px">
        <!-- Profile Title -->
        <label style="display:flex;flex-direction:column;gap:6px">
          <strong style="font-size:.9rem">Profile Title</strong>
          <input type="text" name="profile_title" value="{{ contact_info.profile_title.content }}" required maxlength="50"
            style="padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:1rem" />
          <small style="color:var(--muted);font-size:.8rem">Short description (e.g., "Friendly, Reliable, Local")</small>
        </label>
        
        <!-- Phone Number -->
        <label style="display:flex;flex-direction:column;gap:6px">
          <strong style="font-size:.9rem">Phone Number</strong>
          <input type="text" name="phone" value="{{ contact_info.phone.content }}" required maxlength="30"
            style="padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:1rem" />
          <small style="color:var(--muted);font-size:.8rem">Contact phone number (e.g., "(555) 123-PAWS")</small>
        </label>
        
        <!-- Email Address -->
        <label style="display:flex;flex-direction:column;gap:6px">
          <strong style="font-size:.9rem">Email Address</strong>
          <input type="email" name="email" value="{{ contact_info.email.content }}" required maxlength="60"
            style="padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:1rem" />
          <small style="color:var(--muted);font-size:.8rem">Contact email address</small>
        </label>
      </div>
      
      <div style="margin-top:16px;text-align:right">
        <button class="btn primary" type="submit" style="padding:12px 24px;font-weight:700">Save Contact Information</button>
      </div>
    </form>
  </div>
  
  <!-- Service Areas Editor -->
  <div id="service-areas" style="background:linear-gradient(180deg,rgba(34,197,94,.08),rgba(34,197,94,.03));border:2px solid rgba(34,197,94,.25);border-radius:16px;padding:24px;margin-bottom:32px">
    <h3 style="margin:0 0 16px;color:var(--brand);font-size:1.2rem">üìç Service Areas</h3>
    <p style="margin:0 0 20px;color:var(--muted);font-size:.9rem">Manage the coverage areas displayed on the homepage.</p>
    
    <!-- Existing Areas -->
    <div style="display:grid;gap:12px;margin-bottom:24px">
      {% for area in service_areas %}
      <div style="display:flex;align-items:center;gap:12px;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.05);border-radius:12px;padding:12px">
        <form method="post" action="{{ url_for('admin_service_area_update', area_id=area.id) }}" style="flex:1;display:flex;gap:12px">
          <input type="text" name="name" value="{{ area.name }}" required
            style="flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.9rem" />
          <button class="btn" type="submit" style="background:var(--brand);color:#fff;padding:10px 20px;font-weight:600">Update</button>
        </form>
        <form method="post" action="{{ url_for('admin_service_area_delete', area_id=area.id) }}" onsubmit="return confirm('Delete this service area?')" style="margin:0">
          <button class="btn" type="submit" style="background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;padding:10px 16px;font-weight:600">Delete</button>
        </form>
      </div>
      {% endfor %}
    </div>
    
    <!-- Add New Area -->
    <div style="background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);border-radius:12px;padding:16px">
      <h4 style="margin:0 0 12px;color:var(--text);font-size:1rem">Add New Area</h4>
      <form method="post" action="{{ url_for('admin_service_area_add') }}" style="display:flex;gap:12px">
        <input type="text" name="name" placeholder="Enter area name..." required
          style="flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:.9rem" />
        <button class="btn primary" type="submit" style="padding:10px 24px;font-weight:600">Add Area</button>
      </form>
    </div>
  </div>

  <!-- Dog Breeds Editor -->
  <div id="dog-breeds" style="background:linear-gradient(180deg,rgba(99,102,241,.06),rgba(99,102,241,.02));border:2px solid rgba(99,102,241,.18);border-radius:16px;padding:20px;margin-bottom:32px">
    <h3 style="margin:0 0 12px;color:#6366f1;font-size:1.2rem">üê∂ Dog Breeds</h3>
    <p style="margin:0 0 16px;color:var(--muted);font-size:.9rem">A single searchable dropdown control ‚Äî type to filter, select to edit or delete, or type a new breed and click Add.</p>

    <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
      <div style="flex:1;position:relative">
        <input id="breed-search" type="text" placeholder="Type to search or add a new breed..." autocomplete="off"
          style="width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);color:var(--text);font-size:.95rem" />
  <div id="breed-dropdown" style="position:absolute;left:0;right:0;z-index:40;background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:8px;margin-top:8px;display:none;max-height:220px;overflow:auto;box-shadow:0 6px 18px rgba(0,0,0,.08);color:#000"></div>
      </div>
      <button id="breed-add-btn" class="btn primary" type="button" style="padding:10px 18px;font-weight:700">Add</button>
    </div>

    <!-- AI Guidance and Provider Status -->
    <div style="display:flex;gap:12px;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap">
      <form method="post" action="{{ url_for('admin_ai_breeds_guidance_update') }}" style="flex:1;min-width:320px">
        <label style="display:flex;flex-direction:column;gap:6px">
          <strong style="font-size:.9rem">AI Answer Guidance (optional)</strong>
          <textarea name="ai_breeds_guidance" rows="2" placeholder="Optional: instruct the AI how to choose breeds (e.g. 'Prefer family-friendly, non-shedding breeds; avoid toy breeds')" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);color:var(--text);font-size:.9rem">{{ ai_breeds_guidance }}</textarea>
        </label>
        <div style="text-align:right;margin-top:8px">
          <button class="btn" type="submit" style="padding:8px 14px;font-weight:700">Save Guidance</button>
        </div>
      </form>

      <div style="min-width:220px;display:flex;align-items:center;gap:10px">
        <button id="ai-status-btn" class="btn" type="button" style="padding:8px 12px;font-weight:700;display:inline-flex;align-items:center;gap:8px">Check AI API</button>
        <div id="ai-status-indicator" title="API status" style="width:18px;height:18px;border-radius:50%;background:#bdbdbd;border:2px solid rgba(0,0,0,.06)"></div>
        <div id="ai-status-message" style="color:var(--muted);font-size:.9rem"></div>
        <div id="ai-status-details" style="display:block;width:100%;margin-top:6px;color:var(--muted);font-size:.8rem;white-space:pre-wrap"></div>
      </div>
    </div>

    <div id="breed-selected" style="display:none;background:rgba(0,0,0,.12);border:1px solid rgba(255,255,255,.04);border-radius:12px;padding:12px;margin-bottom:12px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div>
          <strong id="sel-title" style="font-size:1rem;color:var(--text)"></strong>
          <div id="sel-content" style="color:var(--muted);font-size:.9rem"></div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="sel-edit" class="btn" type="button" style="background:var(--brand);color:#fff;padding:8px 12px;font-weight:700">Edit</button>
          <button id="sel-delete" class="btn" type="button" style="background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;padding:8px 12px;font-weight:700">Delete</button>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="breed-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:60">
      <div style="background:var(--bg);padding:18px;border-radius:12px;max-width:520px;width:100%;box-shadow:0 10px 30px rgba(0,0,0,.6)">
        <h4 style="margin:0 0 8px;color:var(--text)">Edit Breed</h4>
        <div style="display:grid;gap:10px">
          <input id="modal-title" type="text" placeholder="Breed name" style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);color:var(--text)" />
          <input id="modal-content" type="text" placeholder="Optional note" style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);color:var(--muted)" />
        </div>
        <div style="text-align:right;margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button id="modal-cancel" class="btn" type="button" style="padding:8px 14px">Cancel</button>
          <button id="modal-save" class="btn primary" type="button" style="padding:8px 14px">Save</button>
        </div>
      </div>
    </div>

    <!-- AI-driven Breeds Update (Preview + Confirm) -->
    <div id="ai-breeds-panel" style="background:linear-gradient(180deg,rgba(14,165,233,.04),rgba(14,165,233,.01));border:1px solid rgba(14,165,233,.08);border-radius:12px;padding:16px;margin-top:12px">
      <h4 style="margin:0 0 12px;color:var(--text);font-size:1rem">AI Prompt (natural language)</h4>
      <p style="margin:0 0 10px;color:var(--muted);font-size:.85rem">Type instructions like: "Add generally small companion breeds" or "Remove aggressive breeds". Click <strong>Run (Preview)</strong> to see proposed changes, then <strong>Apply Changes</strong> to commit them.</p>
      <textarea id="ai-breeds-prompt" rows="3" placeholder="E.g. add small companion breeds, remove aggressive working breeds" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);color:var(--text);font-size:.95rem"></textarea>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="ai-run-preview" class="btn" type="button" style="background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;padding:8px 16px;font-weight:700">Run (Preview)</button>
        <button id="ai-apply" class="btn" type="button" style="background:linear-gradient(135deg,#10b981,#059669);color:#fff;padding:8px 16px;font-weight:700;display:none">Apply Changes</button>
        <button id="ai-clear" class="btn" type="button" style="background:rgba(255,255,255,.04);padding:8px 12px;color:var(--muted)">Clear</button>
      </div>

      <div id="ai-breeds-result" style="margin-top:12px;display:none">
        <h5 style="margin:0 0 8px;color:var(--text);font-size:.95rem">AI Result</h5>
        <div id="ai-breeds-summary" style="background:rgba(0,0,0,.05);padding:12px;border-radius:8px;color:var(--muted);white-space:pre-wrap"></div>
        <div id="ai-breeds-proposed" style="margin-top:8px;display:flex;gap:12px;flex-wrap:wrap"></div>
      </div>
    </div>
  </div>
  
  <!-- Homepage Section Order -->
  <div id="homepage-sections" style="background:linear-gradient(180deg,rgba(139,92,246,.08),rgba(139,92,246,.03));border:2px solid rgba(139,92,246,.25);border-radius:16px;padding:24px;margin-bottom:32px">
    <h3 style="margin:0 0 16px;color:#a78bfa;font-size:1.2rem">üîÄ Homepage Section Order</h3>
    <p style="margin:0 0 20px;color:var(--muted);font-size:.9rem">Reorder sections on the homepage by moving them up or down. You can also hide sections by toggling visibility.</p>
    
    <!-- Sections List -->
    <div style="display:grid;gap:12px">
      {% for section in homepage_sections %}
      <div style="display:flex;align-items:center;gap:12px;background:{% if section.enabled %}rgba(0,0,0,.2){% else %}rgba(255,68,68,.15){% endif %};border:1px solid {% if section.enabled %}rgba(255,255,255,.05){% else %}rgba(255,68,68,.3){% endif %};border-radius:12px;padding:12px">
        <!-- Section Info -->
        <div style="flex:1;display:flex;align-items:center;gap:12px">
          <div style="background:rgba(139,92,246,.15);border:1px solid rgba(139,92,246,.3);border-radius:8px;padding:6px 10px;font-weight:700;font-size:.85rem;color:#a78bfa;min-width:40px;text-align:center">
            {{ section.sort_order }}
          </div>
          <div>
            <strong style="color:var(--text);font-size:.95rem">{{ section.title }}</strong>
            <br>
            <small style="color:var(--muted);font-size:.8rem">{{ section.section_key }}</small>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div style="display:flex;gap:8px;align-items:center">
          <!-- Move Up -->
          <form method="post" action="{{ url_for('admin_section_move_up', section_id=section.id) }}" style="margin:0">
            <button class="btn" type="submit" style="background:rgba(139,92,246,.2);color:#a78bfa;padding:8px 12px;font-weight:600;font-size:.85rem" {% if loop.first %}disabled{% endif %}>
              ‚Üë
            </button>
          </form>
          
          <!-- Move Down -->
          <form method="post" action="{{ url_for('admin_section_move_down', section_id=section.id) }}" style="margin:0">
            <button class="btn" type="submit" style="background:rgba(139,92,246,.2);color:#a78bfa;padding:8px 12px;font-weight:600;font-size:.85rem" {% if loop.last %}disabled{% endif %}>
              ‚Üì
            </button>
          </form>
          
          <!-- Toggle Visibility -->
          <form method="post" action="{{ url_for('admin_section_toggle', section_id=section.id) }}" style="margin:0">
            <button class="btn" type="submit" style="background:{% if section.enabled %}var(--brand){% else %}#ef4444{% endif %};color:#fff;padding:8px 16px;font-weight:600;font-size:.85rem">
              {% if section.enabled %}üëÅÔ∏è Visible{% else %}üö´ Hidden{% endif %}
            </button>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>
    
    <div style="margin-top:16px;padding:12px;background:rgba(139,92,246,.08);border:1px solid rgba(139,92,246,.2);border-radius:10px">
      <small style="color:var(--muted);font-size:.85rem">
        üí° <strong>Tip:</strong> Use the ‚Üë and ‚Üì buttons to change the order sections appear on the homepage. Hidden sections won't be displayed to visitors.
      </small>
    </div>
  </div>
  
  <div id="services-list" style="margin-top:30px;display:flex;flex-direction:column;gap:24px">
    {% for service in services %}
    <div style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:24px">
      <form method="post" action="{{ url_for('admin_content_update', service_id=service.id) }}">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
          <h3 style="margin:0;background:linear-gradient(135deg,var(--brand),var(--accent-light));-webkit-background-clip:text;background-clip:text;color:transparent">{{ service.title }}</h3>
          <button class="btn primary" type="submit">Save Changes</button>
        </div>
        
        <div style="display:grid;gap:16px">
          <label style="display:flex;flex-direction:column;gap:6px">
            <strong style="font-size:.9rem">Service Title</strong>
            <input type="text" name="title" value="{{ service.title }}" required
              style="padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:1rem" />
          </label>
          
          <label style="display:flex;flex-direction:column;gap:6px">
            <strong style="font-size:.9rem">Price</strong>
            <input type="text" name="price" value="{{ service.price }}" placeholder="e.g., From ¬£14/hour"
              style="padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:1rem" />
            <small style="color:var(--muted);font-size:.8rem">This appears at the top of the accordion panel</small>
          </label>
          
          <label style="display:flex;flex-direction:column;gap:6px">
            <strong style="font-size:.9rem">Description & Details</strong>
            <textarea name="content" rows="8" required
              style="padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);font-size:1rem;font-family:inherit;line-height:1.6;resize:vertical">{{ service.content }}</textarea>
            <small style="color:var(--muted);font-size:.8rem">Use bullet points with "‚Ä¢" or "-" for lists. Each line will be displayed separately.</small>
          </label>
        </div>
        
        <div style="margin-top:12px;padding-top:16px;border-top:1px solid rgba(255,255,255,.08)">
          <details style="cursor:pointer">
            <summary style="font-weight:600;color:var(--accent-light);font-size:.9rem">Preview current content</summary>
            <div style="margin-top:12px;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.05);border-radius:10px;padding:16px">
              <p style="margin:0 0 8px;font-weight:700;color:var(--brand)">{{ service.price }}</p>
              {% set lines = service.content.split('\n') %}
              {% for line in lines %}
                {% if line.strip() %}
                  {% if line.strip().startswith('‚Ä¢') or line.strip().startswith('-') %}
                    <div style="margin-left:16px;font-size:.9rem;color:var(--text)">{{ line.strip() }}</div>
                  {% else %}
                    <p style="margin:8px 0;color:var(--text)">{{ line.strip() }}</p>
                  {% endif %}
                {% endif %}
              {% endfor %}
            </div>
          </details>
        </div>
      </form>
    </div>
    {% endfor %}
  </div>
</section>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const runBtn = document.getElementById('ai-run-preview');
  const applyBtn = document.getElementById('ai-apply');
  const clearBtn = document.getElementById('ai-clear');
  const promptEl = document.getElementById('ai-breeds-prompt');
  const resultPanel = document.getElementById('ai-breeds-result');
  const resultSummary = document.getElementById('ai-breeds-summary');
  const resultProposed = document.getElementById('ai-breeds-proposed');

  function showPreview(data) {
    resultPanel.style.display = '';
    resultSummary.textContent = (data.raw || '').slice(0, 300);
    // Show diagnostics if present in the response
    if (data.diagnostics) {
      const diagEl = document.createElement('div');
      diagEl.style.marginTop = '8px'; diagEl.style.padding = '8px'; diagEl.style.borderRadius = '8px'; diagEl.style.background = 'rgba(0,0,0,.04)'; diagEl.style.color = 'var(--muted)';
      diagEl.textContent = 'Diagnostics: ' + JSON.stringify(data.diagnostics);
      resultProposed.appendChild(diagEl);
    }
    resultProposed.innerHTML = '';
    const adds = data.proposed_add || [];
    const removes = data.proposed_remove || [];
    if (adds.length) {
      const addBox = document.createElement('div');
      addBox.style.padding = '8px'; addBox.style.borderRadius='8px'; addBox.style.background='rgba(16,185,129,.06)'; addBox.style.color='var(--text)';
      addBox.innerHTML = `<strong>To add (${adds.length})</strong><br>${adds.join(', ')}`;
      resultProposed.appendChild(addBox);
    }
    if (removes.length) {
      const remBox = document.createElement('div');
      remBox.style.padding = '8px'; remBox.style.borderRadius='8px'; remBox.style.background='rgba(239,68,68,.06)'; remBox.style.color='var(--text)';
      remBox.innerHTML = `<strong>To remove (${removes.length})</strong><br>${removes.join(', ')}`;
      resultProposed.appendChild(remBox);
    }
    // Show apply button when there is something to apply
    if ((adds.length + removes.length) > 0) {
      applyBtn.style.display = '';
    } else {
      applyBtn.style.display = 'none';
    }
  }

  runBtn.addEventListener('click', () => {
    const prompt = (promptEl.value || '').trim();
    if (!prompt) return alert('Please enter a prompt.');
    runBtn.disabled = true; runBtn.textContent = 'Running...';
    const fd = new FormData(); fd.append('prompt', prompt);
    // include admin guidance so AI respects configured guidance
    const guidanceEl = document.querySelector('textarea[name="ai_breeds_guidance"]');
    if (guidanceEl) fd.append('guidance', guidanceEl.value || '');
    fetch('{{ url_for("admin_breeds_ai_update") }}', { method: 'POST', body: fd, credentials: 'include' })
      .then(r => r.json())
      .then(j => {
        runBtn.disabled = false; runBtn.textContent = 'Run (Preview)';
        if (!j || !j.ok) {
          resultPanel.style.display = '';
          resultSummary.textContent = j && j.raw ? j.raw : (j && j.error ? j.error : 'No result');
          // show diagnostics when present
          if (j && j.diagnostics) {
            resultSummary.textContent += '\n\nDiagnostics: ' + JSON.stringify(j.diagnostics);
          }
          applyBtn.style.display = 'none';
          return;
        }
        showPreview(j);
      })
      .catch(err => {
        runBtn.disabled = false; runBtn.textContent = 'Run (Preview)';
        alert('AI request failed: ' + err);
      });
  });

  applyBtn.addEventListener('click', () => {
    if (!confirm('Apply the proposed changes to the breeds list? This will modify the database.')) return;
    applyBtn.disabled = true; applyBtn.textContent = 'Applying...';
    const fd = new FormData(); fd.append('prompt', promptEl.value || ''); fd.append('confirm', '1');
    const guidanceEl = document.querySelector('textarea[name="ai_breeds_guidance"]');
    if (guidanceEl) fd.append('guidance', guidanceEl.value || '');
    fetch('{{ url_for("admin_breeds_ai_update") }}', { method: 'POST', body: fd, credentials: 'include' })
      .then(r => r.json())
      .then(j => {
        applyBtn.disabled = false; applyBtn.textContent = 'Apply Changes';
        if (j && j.ok) {
          // Reload the page to refresh the breeds list
          window.location.reload();
        } else {
          alert('Apply failed: ' + (j && j.error ? j.error : JSON.stringify(j)));
        }
      })
      .catch(err => {
        applyBtn.disabled = false; applyBtn.textContent = 'Apply Changes';
        alert('Apply request failed: ' + err);
      });
  });

  clearBtn.addEventListener('click', () => {
    promptEl.value = '';
    resultPanel.style.display = 'none';
    applyBtn.style.display = 'none';
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Breeds admin AJAX UI
  const listUrl = '{{ url_for("admin_breeds_list_json") }}';
  const addUrl = '{{ url_for("admin_breeds_json_add") }}';
  const updateUrlBase = '{{ url_for("admin_breeds_json_update", breed_id=0) }}'.replace('/0', '');
  const deleteUrlBase = '{{ url_for("admin_breeds_json_delete", breed_id=0) }}'.replace('/0', '');

  let breeds = [];
  let highlighted = -1;
  const input = document.getElementById('breed-search');
  const dropdown = document.getElementById('breed-dropdown');
  const addBtn = document.getElementById('breed-add-btn');
  const selBox = document.getElementById('breed-selected');
  const selTitle = document.getElementById('sel-title');
  const selContent = document.getElementById('sel-content');
  const selEdit = document.getElementById('sel-edit');
  const selDelete = document.getElementById('sel-delete');
  const modal = document.getElementById('breed-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalContent = document.getElementById('modal-content');
  const modalCancel = document.getElementById('modal-cancel');
  const modalSave = document.getElementById('modal-save');

  function renderDropdown(items) {
    dropdown.innerHTML = '';
    if (!items.length) {
      dropdown.style.display = 'none';
      return;
    }
    items.forEach((b, i) => {
      const d = document.createElement('div');
      d.textContent = b.title + (b.content ? ' ‚Äî ' + b.content : '');
      d.dataset.index = i;
      d.style.padding = '8px 12px';
      d.style.cursor = 'pointer';
      d.style.borderBottom = '1px solid rgba(0,0,0,.04)';
      d.style.background = '#fff';
      d.style.color = '#000';
      d.addEventListener('click', () => { selectBreed(b); hideDropdown(); });
      d.addEventListener('mouseenter', () => { d.style.background = '#f3f4f6'; });
      d.addEventListener('mouseleave', () => { d.style.background = '#fff'; });
      dropdown.appendChild(d);
    });
    highlighted = -1;
    dropdown.style.display = '';
  }

  function hideDropdown() {
    dropdown.style.display = 'none';
  }

  function filterBreeds(q) {
    q = (q || '').toLowerCase().trim();
    if (!q) return breeds.slice(0, 50);
    return breeds.filter(b => (b.title || '').toLowerCase().includes(q)).slice(0, 200);
  }

  function selectBreed(b) {
    if (!b) return;
    selBox.style.display = '';
    selTitle.textContent = b.title;
    selContent.textContent = b.content || '';
    selBox.dataset.id = b.id;
    input.value = b.title;
  }

  function clearSelection() {
    selBox.style.display = 'none';
    delete selBox.dataset.id;
  }

  function loadBreeds() {
    fetch(listUrl, {credentials: 'include'}).then(r => r.json()).then(j => {
      if (j && j.ok) {
        breeds = j.breeds || [];
      } else {
        breeds = [];
      }
    }).catch(() => { breeds = []; });
  }

  // initial load
  loadBreeds();

  // Show dropdown when the input is focused (show all items) or clicked
  input.addEventListener('focus', (e) => {
    const items = filterBreeds('');
    if (items.length) renderDropdown(items);
  });
  input.addEventListener('click', (e) => {
    // If dropdown already visible, keep it; otherwise show full list
    if (dropdown.style.display === 'none' || !dropdown.style.display) {
      const items = filterBreeds('');
      if (items.length) renderDropdown(items);
    }
  });

  input.addEventListener('input', (e) => {
    const q = e.target.value || '';
    const items = filterBreeds(q);
    if (items.length) renderDropdown(items);
    else {
      // show suggestion of exact match only
      dropdown.innerHTML = '';
      dropdown.style.display = 'none';
    }
  });

  input.addEventListener('keydown', (e) => {
    const items = Array.from(dropdown.children);
    if (!items.length) return;
    if (e.key === 'ArrowDown') {
      e.preventDefault(); highlighted = Math.min(highlighted + 1, items.length - 1);
      items.forEach((it, idx)=>{ it.style.background = '#fff'; });
      items[highlighted].style.background = '#f3f4f6';
    } else if (e.key === 'ArrowUp') {
      e.preventDefault(); highlighted = Math.max(highlighted - 1, 0);
      items.forEach((it, idx)=>{ it.style.background = '#fff'; });
      items[highlighted].style.background = '#f3f4f6';
    } else if (e.key === 'Enter') {
      e.preventDefault(); if (highlighted >= 0 && items[highlighted]) items[highlighted].click();
    } else if (e.key === 'Escape') { hideDropdown(); }
  });

  // Add new breed
  addBtn.addEventListener('click', () => {
    const val = (input.value || '').trim();
    if (!val) return alert('Please type a breed name to add.');
    // If an identical breed exists, select it
    const existing = breeds.find(b => (b.title||'').toLowerCase() === val.toLowerCase());
    if (existing) { selectBreed(existing); return; }
    addBtn.disabled = true; addBtn.textContent = 'Adding...';
    fetch(addUrl, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({title: val, content: ''}), credentials: 'include' })
      .then(r => r.json())
      .then(j => {
        addBtn.disabled = false; addBtn.textContent = 'Add';
        if (j && j.ok && j.breed) {
          breeds.unshift(j.breed);
          selectBreed(j.breed);
        } else {
          alert('Add failed: ' + (j && j.error ? j.error : JSON.stringify(j)));
        }
      }).catch(err => { addBtn.disabled = false; addBtn.textContent = 'Add'; alert('Add request failed: ' + err); });
  });

  selEdit.addEventListener('click', () => {
    const id = selBox.dataset.id; if (!id) return;
    const b = breeds.find(x => String(x.id) === String(id)); if (!b) return;
    modal.style.display = 'flex';
    modalTitle.value = b.title || '';
    modalContent.value = b.content || '';
    modal.dataset.editId = id;
  });

  modalCancel.addEventListener('click', () => { modal.style.display = 'none'; delete modal.dataset.editId; });

  modalSave.addEventListener('click', () => {
    const id = modal.dataset.editId; if (!id) return;
    const title = (modalTitle.value || '').trim(); const content = (modalContent.value || '').trim();
    if (!title) return alert('Title required');
    modalSave.disabled = true; modalSave.textContent = 'Saving...';
    fetch(updateUrlBase + '/' + id, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({title: title, content: content}), credentials: 'include' })
      .then(r => r.json()).then(j => {
        modalSave.disabled = false; modalSave.textContent = 'Save';
        if (j && j.ok && j.breed) {
          // update local list
          const idx = breeds.findIndex(x => String(x.id) === String(id));
          if (idx >= 0) breeds[idx] = j.breed;
          selectBreed(j.breed);
          modal.style.display = 'none';
        } else {
          alert('Update failed: ' + (j && j.error ? j.error : JSON.stringify(j)));
        }
      }).catch(err => { modalSave.disabled = false; modalSave.textContent = 'Save'; alert('Update failed: ' + err); });
  });

  selDelete.addEventListener('click', () => {
    const id = selBox.dataset.id; if (!id) return;
    if (!confirm('Delete this breed? This cannot be undone.')) return;
    selDelete.disabled = true; selDelete.textContent = 'Deleting...';
    fetch(deleteUrlBase + '/' + id, { method: 'POST', credentials: 'include' })
      .then(r => r.json()).then(j => {
        selDelete.disabled = false; selDelete.textContent = 'Delete';
        if (j && j.ok) {
          breeds = breeds.filter(x => String(x.id) !== String(id));
          clearSelection();
          input.value = '';
        } else {
          alert('Delete failed: ' + (j && j.error ? j.error : JSON.stringify(j)));
        }
      }).catch(err => { selDelete.disabled = false; selDelete.textContent = 'Delete'; alert('Delete failed: ' + err); });
  });

  // close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest || (!e.target.closest('#breed-search') && !e.target.closest('#breed-dropdown') && !e.target.closest('#breed-add-btn'))) {
      hideDropdown();
    }
  });

  // refresh list periodically (to pick up server changes)
  setInterval(loadBreeds, 60 * 1000);
});
</script>
{% endblock %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const statusBtn = document.getElementById('ai-status-btn');
  const statusInd = document.getElementById('ai-status-indicator');
  const statusMsg = document.getElementById('ai-status-message');
  if (statusBtn) {
    statusBtn.addEventListener('click', () => {
      statusBtn.disabled = true; statusBtn.textContent = 'Checking...';
      statusInd.style.background = '#f59e0b'; // amber while checking
      statusMsg.textContent = '';
      fetch('{{ url_for("admin_ai_status") }}', { credentials: 'include' })
        .then(r => r.json())
        .then(j => {
          statusBtn.disabled = false; statusBtn.textContent = 'Check AI API';
          try {
            // Consider DeepSeek too when determining overall API health
            const ok = (j.openai && j.openai.model_ok) || (j.deepseek && j.deepseek.model_ok) || (j.gemini && j.gemini.model_ok) || (j.provider && j.provider !== 'none' && ((j.openai && j.openai.env_present) || (j.deepseek && j.deepseek.env_present) || (j.gemini && j.gemini.env_present)));
            const detailsEl = document.getElementById('ai-status-details');
            if (ok) {
              statusInd.style.background = '#10b981'; // green
              statusMsg.textContent = 'API reachable';
            } else {
              statusInd.style.background = '#ef4444'; // red
              // Prefer deepseek error when present, then openai, then gemini
              statusMsg.textContent = (j.deepseek && j.deepseek.error) ? j.deepseek.error : (j.openai && j.openai.error ? j.openai.error : (j.gemini && j.gemini.error ? j.gemini.error : 'No provider responded.'));
            }
            if (detailsEl) {
              detailsEl.textContent = JSON.stringify(j, null, 2);
            }
          } catch (e) {
            statusInd.style.background = '#ef4444';
            statusMsg.textContent = 'Error parsing status';
          }
        })
        .catch(err => {
          statusBtn.disabled = false; statusBtn.textContent = 'Check AI API';
          statusInd.style.background = '#ef4444';
          statusMsg.textContent = 'Network error';
          const detailsEl = document.getElementById('ai-status-details');
          if (detailsEl) detailsEl.textContent = String(err);
        });
    });
  }
  // Auto-check AI API once on page load so indicator is visible immediately
  try {
    if (statusBtn && typeof statusBtn.click === 'function') statusBtn.click();
  } catch (e) {
    // ignore
  }
});
</script>
