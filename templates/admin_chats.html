{% extends 'base.html' %}
{% block title %}Live Chats{% endblock %}
{% block content %}
<div style="max-width:1100px;margin:0 auto;padding:8px 20px 6px;display:flex;align-items:center;justify-content:space-between;gap:12px">
  <a href="{{ url_for('admin_dashboard') }}" style="display:inline-flex;align-items:center;gap:8px;padding:8px 14px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:10px;color:var(--text);text-decoration:none;font-weight:600;transition:all .2s" onmouseover="this.style.background='rgba(255,255,255,.12)';this.style.transform='translateX(-4px)'" onmouseout="this.style.background='rgba(255,255,255,.08)';this.style.transform='translateX(0)'>
    ← Back to Dashboard
  </a>
  <form method="post" action="{{ url_for('admin_chats_close_all') }}" onsubmit="return confirm('Close all open chats? This will mark them closed for visitors.')" style="margin:0">
    <button class="btn danger" type="submit" style="padding:8px 14px;font-weight:700">Close all chats</button>
  </form>
</div>
<section class="container" style="max-width:1100px;padding-top:6px">
  <div style="margin-top:20px">
    <table id="admin-chats-table" style="width:100%;border-collapse:collapse;background:var(--panel);box-shadow:0 8px 30px rgba(2,6,23,0.15);border-radius:10px;overflow:hidden">
      <thead style="background:linear-gradient(90deg,#0ea5a4,#06b6d4);color:#fff;text-align:left">
        <tr>
          <th style="padding:12px 16px;width:80px">Chat #</th>
          <th style="padding:12px 16px">Visitor</th>
          <th style="padding:12px 16px;width:220px">SID</th>
          <th style="padding:12px 16px;width:120px">Status</th>
          <th style="padding:12px 16px;width:220px">Last activity</th>
          <th style="padding:12px 16px;width:260px">Actions</th>
        </tr>
      </thead>
      <tbody style="background:var(--panel-2);color:var(--text)">
        {% if chats|length == 0 %}
        <tr><td colspan="6" style="padding:18px;color:var(--muted);text-align:center">No chats yet.</td></tr>
        {% else %}
    {% for c in chats %}
  <tr data-chat-id="{{ c.id }}" class="chat-row {% if c.status == 'open' %}row-waiting{% endif %}" style="border-bottom:1px solid rgba(255,255,255,.04);">
          <td style="padding:12px 16px;font-weight:700">#{{ c.id }}</td>
          <td style="padding:12px 16px">
            <div style="font-weight:700">{{ c.name or 'Visitor' }}</div>
          </td>
          <td style="padding:12px 16px;color:var(--muted);font-size:.85rem">{{ c.sid or '—' }}</td>
          <td style="padding:12px 16px">
            {% if c.status == 'open' %}
              <span style="display:inline-block;padding:6px 10px;border-radius:999px;background:#fffbeb;color:#92400e;font-weight:700;border:1px solid rgba(250,204,21,.08)">Waiting</span>
            {% elif c.status == 'closed' %}
              <span style="display:inline-block;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,.06);color:var(--muted);font-weight:600">Closed</span>
            {% else %}
              <span style="display:inline-block;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,.04);color:var(--muted);font-weight:600">{{ c.status }}</span>
            {% endif %}
          </td>
          <td style="padding:12px 16px;color:var(--muted)">{{ c.last_activity|uk_datetime }}</td>
          <td style="padding:12px 16px;display:flex;gap:8px;align-items:center">
            <a class="btn ghost" href="{{ url_for('admin_chat_view', chat_id=c.id) }}" style="padding:8px 12px">Open</a>
            {% if c.status != 'closed' %}
            <form method="post" action="{{ url_for('admin_chat_close', chat_id=c.id) }}" style="margin:0;display:inline-block">
              <button class="btn" style="background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;padding:8px 12px" type="submit">Close</button>
            </form>
            {% else %}
            <form method="post" action="{{ url_for('admin_chat_delete', chat_id=c.id) }}" style="margin:0;display:inline-block" onsubmit="return confirm('Delete closed chat #{{ c.id }}? This cannot be undone.')">
              <button class="btn" style="background:#444;color:#fff;padding:8px 12px" type="submit">Delete</button>
            </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% endif %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
{% block extra_js %}
<script>
// Smooth auto-refresh: fetch and update chat list every 3s without page reload
(function(){
  const tbody = document.querySelector('#admin-chats-table tbody');
  if(!tbody) return;

  let timer;
  let isInteracting = false;

  async function refresh(){
    if(isInteracting) return;
    try{
      const r = await fetch('/admin/chats/list.json', {cache:'no-store'});
      if(!r.ok) return;
      const j = await r.json();
      if(!j || !j.chats) return;
      const chats = j.chats;
      // Build table rows
      if(!tbody) return;
      let out = '';
      if(chats.length === 0){
        out = '<tr><td colspan="6" style="padding:18px;color:var(--muted);text-align:center">No chats yet.</td></tr>';
      } else {
        for(const c of chats){
          const last = (c.last_activity||'');
          const trClass = c.status === 'open' ? ' class="row-waiting"' : '';
          out += '<tr data-chat-id="'+c.id+'"'+trClass+' style="border-bottom:1px solid rgba(255,255,255,.04);">';
          out += '<td style="padding:12px 16px;font-weight:700">#'+c.id+'</td>';
          out += '<td style="padding:12px 16px"><div style="font-weight:700">'+(c.name||'Visitor')+'</div></td>';
          out += '<td style="padding:12px 16px;color:var(--muted);font-size:.85rem">'+(c.sid||'—')+'</td>';
          // row highlight handled via CSS class 'row-waiting'
          // Display status: prefer display_status (server-computed) when present
          const disp = c.display_status || c.status;
          if(disp === 'open'){
            out += '<td style="padding:12px 16px"><span class="chat-badge waiting">Waiting</span></td>';
          } else if(disp === 'ended'){
            const ago = c.age_minutes ? Math.round(c.age_minutes/60) + 'h ago' : '';
            out += '<td style="padding:12px 16px"><span class="chat-badge ended">Ended'+(ago ? ' • '+ago : '')+'</span></td>';
          } else if(disp === 'closed'){
            out += '<td style="padding:12px 16px"><span class="chat-badge closed">Closed</span></td>';
          } else {
            out += '<td style="padding:12px 16px"><span class="chat-badge">'+(disp||'')+'</span></td>';
          }
          out += '<td style="padding:12px 16px;color:var(--muted)">'+last+'</td>';
          out += '<td style="padding:12px 16px;display:flex;gap:8px;align-items:center">';
          out += '<a class="btn ghost" href="/admin/chats/'+c.id+'" style="padding:8px 12px">Open</a>';
          if(c.status !== 'closed'){
            out += '<form method="post" action="/admin/chats/close/'+c.id+'" style="margin:0;display:inline-block"><button class="btn" style="background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;padding:8px 12px" type="submit">Close</button></form>';
          } else {
            out += '<form method="post" action="/admin/chats/delete/'+c.id+'" style="margin:0;display:inline-block" onsubmit="return confirm(\'Delete closed chat #'+c.id+'? This cannot be undone.\')"><button class="btn" style="background:#444;color:#fff;padding:8px 12px" type="submit">Delete</button></form>';
          }
          out += '</td>';
          out += '</tr>';
        }
      }
      if(out !== tbody.innerHTML) tbody.innerHTML = out;
    }catch(e){}
  }

  timer = setInterval(refresh, 3000);
  
  // Pause refresh when user is interacting
  document.addEventListener('mousedown', ()=>{ isInteracting=true; setTimeout(()=>isInteracting=false, 2000); });
  document.addEventListener('keydown', ()=>{ isInteracting=true; setTimeout(()=>isInteracting=false, 2000); });
})();
</script>
{% endblock %}