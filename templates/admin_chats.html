{% extends 'base.html' %}
{% block title %}Live Chats{% endblock %}
{% block content %}
<div style="max-width:1100px;margin:0 auto;padding:20px 20px 0">
  <a href="{{ url_for('admin_dashboard') }}" style="display:inline-flex;align-items:center;gap:8px;padding:10px 20px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:10px;color:var(--text);text-decoration:none;font-weight:600;transition:all .2s;margin-bottom:20px" onmouseover="this.style.background='rgba(255,255,255,.12)';this.style.transform='translateX(-4px)'" onmouseout="this.style.background='rgba(255,255,255,.08)';this.style.transform='translateX(0)'">
    ← Back to Dashboard
  </a>
</div>
<section class="container" style="max-width:1100px">
  <h1 style="margin-bottom:10px">Live Chats</h1>
  <p style="margin-top:0;color:var(--muted)">Real‑time conversations initiated by visitors. Open chats first.</p>
  <div class="cards-grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr));margin-top:30px">
    {% for c in chats %}
    <div class="card" style="position:relative;padding:20px;display:flex;flex-direction:column;gap:8px">
      {% if c.status == 'open' %}
      <span style="position:absolute;top:12px;right:12px;width:10px;height:10px;border-radius:50%;background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.25)" title="Active chat"></span>
      {% endif %}
      <div style="font-weight:600;font-size:1.05rem;display:flex;align-items:center;gap:8px">
        <span style="padding:4px 10px;border-radius:20px;background:rgba(34,197,94,.15);font-size:.75rem;letter-spacing:.5px;text-transform:uppercase">#{{ c.id }}</span>
        <span>{{ c.name or 'Visitor' }}</span>
      </div>
      <div style="font-size:.8rem;color:var(--muted)">SID: {{ c.sid or '—' }}</div>
      <div style="display:flex;align-items:center;gap:6px;font-size:.75rem">
        {% if c.status == 'open' %}
        <span style="padding:4px 8px;border-radius:8px;background:rgba(34,197,94,.18);color:var(--brand)">{{ c.status }}</span>
        {% else %}
        <span style="padding:4px 8px;border-radius:8px;background:rgba(255,255,255,.08);color:var(--muted)">{{ c.status }}</span>
        {% endif %}
        <span style="color:var(--muted)">Last: {{ c.last_activity|uk_datetime }}</span>
      </div>
      <a href="{{ url_for('admin_chat_view', chat_id=c.id) }}" class="btn ghost" style="margin-top:4px;padding:10px 14px">Open</a>
      {% if c.status!='closed' %}
      <form method="post" action="{{ url_for('admin_chat_close', chat_id=c.id) }}" style="margin-top:4px">
        <button class="btn" style="background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;padding:10px 14px" type="submit">Close Chat</button>
      </form>
      {% endif %}
    </div>
    {% else %}
    <p>No chats yet.</p>
    {% endfor %}
  </div>
</section>
{% endblock %}
{% block extra_js %}
<script>
// Smooth auto-refresh: fetch and update chat list every 3s without page reload
(function(){
  const container = document.querySelector('.cards-grid');
  if(!container) return;
  
  let timer;
  let isInteracting = false;
  
  async function refresh(){
    if(isInteracting) return;
    try{
      const r = await fetch(window.location.href);
      const html = await r.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newGrid = doc.querySelector('.cards-grid');
      if(newGrid && newGrid.innerHTML !== container.innerHTML){
        container.innerHTML = newGrid.innerHTML;
      }
    }catch(e){}
  }
  
  timer = setInterval(refresh, 3000);
  
  // Pause refresh when user is interacting
  document.addEventListener('mousedown', ()=>{ isInteracting=true; setTimeout(()=>isInteracting=false, 2000); });
  document.addEventListener('keydown', ()=>{ isInteracting=true; setTimeout(()=>isInteracting=false, 2000); });
})();
</script>
{% endblock %}