{% extends 'base.html' %}
{% block title %}Admin Dashboard{% endblock %}
{% block extra_head %}
<style>
  .admin-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;max-width:1200px;margin:20px auto;padding:0 clamp(20px,5vw,60px)}
  @media(max-width:900px){.admin-grid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:600px){.admin-grid{grid-template-columns:1fr}}
  .admin-card{background:linear-gradient(180deg,rgba(16,185,129,.08),rgba(16,185,129,.03));border:2px solid rgba(16,185,129,.25);border-radius:16px;padding:18px;cursor:pointer;transition:all .35s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden}
  .admin-card::before{content:'';position:absolute;top:0;right:0;width:60px;height:60px;background:radial-gradient(circle,rgba(34,197,94,.2),transparent 70%);pointer-events:none}
  .admin-card:hover{transform:translateY(-4px);box-shadow:0 16px 50px rgba(16,185,129,.3),0 6px 24px rgba(0,0,0,.5);border-color:var(--brand)}
  .admin-card-icon{font-size:2rem;margin-bottom:8px}
  .admin-card h2{margin:0 0 4px;font-size:1.1rem;background:linear-gradient(135deg,var(--brand),var(--accent-light));-webkit-background-clip:text;background-clip:text;color:transparent}
  .admin-card p{color:var(--muted);margin:0;font-size:.8rem;line-height:1.4}
  .admin-card .badge{position:absolute;top:10px;right:10px;background:var(--brand);color:#fff;padding:3px 8px;border-radius:10px;font-size:.7rem;font-weight:700;box-shadow:0 4px 12px rgba(34,197,94,.4)}
  @keyframes pulse-glow{0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,.7),0 16px 50px rgba(16,185,129,.3)}50%{box-shadow:0 0 20px 8px rgba(34,197,94,.4),0 16px 50px rgba(16,185,129,.5)}}
  .admin-card.pulse{animation:pulse-glow 2s ease-in-out infinite}
  .admin-section{display:none;max-width:1200px;margin:0 auto;padding:20px clamp(20px,5vw,60px)}
  .admin-section.active{display:block}
  .admin-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
  .admin-header h1{margin:0}
  .back-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);color:var(--text);padding:10px 20px;border-radius:12px;cursor:pointer;font-weight:600;transition:all .25s}
  .back-btn:hover{background:rgba(255,255,255,.12);transform:translateX(-4px)}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .admin-section.active{animation:fadeIn .4s ease}
</style>
{% endblock %}
{% block content %}

<!-- Dashboard Cards -->
<div id="dashboard-cards" class="admin-grid">
  <div class="admin-card {% if open_chats > 0 %}pulse{% endif %}" onclick="showSection('chats')">
    {% if open_chats > 0 %}<span class="badge">{{ open_chats }}</span>{% endif %}
    <div class="admin-card-icon">üí¨</div>
    <h2>Live Chat Console</h2>
    <p>View and respond to visitor chats in real-time.</p>
  </div>
  
  <div class="admin-card {% if new_enquiries > 0 %}pulse{% endif %}" onclick="showSection('enquiries')">
    {% if new_enquiries > 0 %}<span class="badge">{{ new_enquiries }}</span>{% endif %}
    <div class="admin-card-icon">üì¨</div>
    <h2>Enquiries</h2>
    <p>Review contact form submissions and inquiries.</p>
  </div>
  
  <div class="admin-card {% if pending_bookings > 0 %}pulse{% endif %}" onclick="showSection('bookings')">
    {% if pending_bookings > 0 %}<span class="badge">{{ pending_bookings }}</span>{% endif %}
    <div class="admin-card-icon">üìÖ</div>
    <h2>Bookings</h2>
    <p>Manage booking slots and customer reservations.</p>
  </div>
  
  <div class="admin-card {% if active_visitors > 0 %}pulse{% endif %}" onclick="showSection('visitors')">
    {% if active_visitors > 0 %}<span class="badge">{{ active_visitors }}</span>{% endif %}
    <div class="admin-card-icon">üë•</div>
    <h2>Visitors Analytics</h2>
    <p>Track visitor activity and behavior patterns.</p>
  </div>
  
  <div class="admin-card" onclick="showSection('ip-management')">
    <div class="admin-card-icon">üõ°Ô∏è</div>
    <h2>IP Management</h2>
    <p>Track IPs, locations, and manage access controls.</p>
  </div>
  
  <div class="admin-card" onclick="showSection('content')">
    <div class="admin-card-icon">‚öôÔ∏è</div>
    <h2>Website Settings</h2>
    <p>Edit services, pricing, and page content.</p>
  </div>
</div>

<!-- Live Chats Section -->
<div id="section-chats" class="admin-section">
  <div class="admin-header">
    <h1>Live Chat Console</h1>
    <button class="back-btn" onclick="showDashboard()">‚Üê Back to Dashboard</button>
  </div>
  <div id="chats-content"></div>
</div>

<!-- Enquiries Section -->
<div id="section-enquiries" class="admin-section">
  <div class="admin-header">
    <h1>Enquiries</h1>
    <button class="back-btn" onclick="showDashboard()">‚Üê Back to Dashboard</button>
  </div>
  <div id="enquiries-content"></div>
</div>

<!-- Bookings Section -->
<div id="section-bookings" class="admin-section">
  <div class="admin-header">
    <h1>Bookings</h1>
    <button class="back-btn" onclick="showDashboard()">‚Üê Back to Dashboard</button>
  </div>
  <div id="bookings-content"></div>
</div>

<!-- Visitors Section -->
<div id="section-visitors" class="admin-section">
  <div class="admin-header">
    <h1>Visitors Analytics</h1>
    <button class="back-btn" onclick="showDashboard()">‚Üê Back to Dashboard</button>
  </div>
  <div id="visitors-content"></div>
</div>

<!-- IP Management Section -->
<div id="section-ip-management" class="admin-section">
  <div class="admin-header">
    <h1>IP Management</h1>
    <button class="back-btn" onclick="showDashboard()">‚Üê Back to Dashboard</button>
  </div>
  <div id="ip-management-content"></div>
</div>

<!-- Website Settings Section -->
<div id="section-content" class="admin-section">
  <div class="admin-header">
    <h1>Website Settings</h1>
    <button class="back-btn" onclick="showDashboard()">‚Üê Back to Dashboard</button>
  </div>
  <div id="content-content"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh dashboard status
let dashboardPollTimer;

async function refreshDashboardStatus(){
  try{
    const r = await fetch('/admin/status.json');
    const data = await r.json();
    
    // Update Live Chat card
    const chatCard = document.querySelector('[onclick="showSection(\'chats\')"]');
    updateCard(chatCard, data.open_chats);
    
    // Update Enquiries card
    const enqCard = document.querySelector('[onclick="showSection(\'enquiries\')"]');
    updateCard(enqCard, data.new_enquiries);
    
    // Update Visitors card
    const visCard = document.querySelector('[onclick="showSection(\'visitors\')"]');
    updateCard(visCard, data.active_visitors);
  }catch(e){}
}

function updateCard(card, count){
  if(!card) return;
  
  // Update or remove pulse class
  if(count > 0){
    if(!card.classList.contains('pulse')) card.classList.add('pulse');
  } else {
    card.classList.remove('pulse');
  }
  
  // Update or remove badge
  let badge = card.querySelector('.badge');
  if(count > 0){
    if(!badge){
      badge = document.createElement('span');
      badge.className = 'badge';
      card.appendChild(badge);
    }
    badge.textContent = count;
  } else {
    if(badge) badge.remove();
  }
}

// Start polling when dashboard is visible
function startDashboardPolling(){
  if(dashboardPollTimer) clearInterval(dashboardPollTimer);
  dashboardPollTimer = setInterval(refreshDashboardStatus, 3000);
}

// Stop polling when navigating away
function stopDashboardPolling(){
  if(dashboardPollTimer) clearInterval(dashboardPollTimer);
}

async function showSection(name){
  // Stop dashboard polling
  stopDashboardPolling();
  
  // Hide dashboard cards
  document.getElementById('dashboard-cards').style.display='none';
  
  // Show section
  const section = document.getElementById('section-'+name);
  section.classList.add('active');
  
  // Load content
  const contentDiv = document.getElementById(name+'-content');
  try{
    let url;
    if(name==='chats') url='/admin/chats';
    else if(name==='enquiries') url='/admin/enquiries';
    else if(name==='bookings') url='/admin/bookings';
    else if(name==='visitors') url='/admin/visitors';
    else if(name==='ip-management') url='/admin/ip-management';
    else if(name==='content') url='/admin/content';
    
    const r = await fetch(url);
    const html = await r.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const content = doc.querySelector('.container') || doc.querySelector('section');
    if(content) {
      contentDiv.innerHTML = content.innerHTML;
      
      // Execute scripts in the loaded content
      const scripts = contentDiv.querySelectorAll('script');
      scripts.forEach(oldScript => {
        const newScript = document.createElement('script');
        Array.from(oldScript.attributes).forEach(attr => {
          newScript.setAttribute(attr.name, attr.value);
        });
        newScript.textContent = oldScript.textContent;
        oldScript.parentNode.replaceChild(newScript, oldScript);
      });
    }
    
    // Start polling for chats
    if(name==='chats'){
      if(window.chatPollTimer) clearInterval(window.chatPollTimer);
      window.chatPollTimer = setInterval(async ()=>{
        const r2 = await fetch('/admin/chats');
        const html2 = await r2.text();
        const doc2 = new DOMParser().parseFromString(html2, 'text/html');
        const grid = doc2.querySelector('.cards-grid');
        const currentGrid = contentDiv.querySelector('.cards-grid');
        if(grid && currentGrid && grid.innerHTML !== currentGrid.innerHTML){
          currentGrid.innerHTML = grid.innerHTML;
        }
      }, 3000);
    }
  }catch(e){
    contentDiv.innerHTML='<p style="color:var(--muted)">Error loading content.</p>';
  }
}

function showDashboard(){
  // Stop polling
  if(window.chatPollTimer) clearInterval(window.chatPollTimer);
  
  // Hide all sections
  document.querySelectorAll('.admin-section').forEach(s=>s.classList.remove('active'));
  
  // Show dashboard
  document.getElementById('dashboard-cards').style.display='grid';
  
  // Restart dashboard polling
  startDashboardPolling();
}

// Start polling on page load
startDashboardPolling();
</script>
{% endblock %}
